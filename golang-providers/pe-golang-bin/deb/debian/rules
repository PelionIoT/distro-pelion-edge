#!/usr/bin/make -f
# This file is in the public domain.
# You may freely use, modify, distribute, and relicense it.

# We need DEB_HOST_ARCH, so include the needed makefile snippet
include /usr/share/dpkg/architecture.mk

export GOROOT := $(CURDIR)
export GOPATH := $(CURDIR)/go-workspace/

export GO386=softfloat

# source files generated during building.
# especially zbootstrap.go has different defaultGOARM values on armhf and armel,
# since the value is set from debian/helpers/goenv.sh
GENERATED_FILES := \
	src/cmd/cgo/zdefaultcc.go \
	src/cmd/go/internal/cfg/zdefaultcc.go \
	src/cmd/go/internal/cfg/zosarch.go \
	src/cmd/internal/objabi/zbootstrap.go \
	src/go/build/zcgo.go \
	src/runtime/internal/sys/zversion.go

%:
	+dh $@ $(opt_no_act)

override_dh_auto_clean:
	# remove autogenerated files
	rm -f -v $(GENERATED_FILES)
	# remove built objects
	rm -rf bin pkg

override_dh_strip:
	dh_strip -Xtestdata

# Do not run dh_dwz, as there is no debug information currently.
override_dh_dwz:

override_dh_strip_nondeterminism:
	dh_strip_nondeterminism -Xtestdata

override_dh_shlibdeps:
	dh_shlibdeps -Xtestdata -Xtest

override_dh_makeshlibs:
	dh_makeshlibs -Xtestdata -Xtest

override_dh_auto_build-arch:
	echo "+CVE-2021-29923" >> VERSION

	# See: https://go.dev/doc/install/source
	export GOROOT_BOOTSTRAP="$(CURDIR)/bootstrap" \
	&& cd $(CURDIR)/src \
	&& bash ./make.bash --no-banner

opt_no_act :=
ifneq (,$(findstring n,$(MAKEFLAGS)))
	opt_no_act := --no-act
endif

